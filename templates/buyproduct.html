{% load static %}
{% include "users/header4.html" %}

<div class="container">
    <div class="row checkout">
        <div class="col-lg-12">
            <div class="box-element">
              <a class="btn btn-dark cart-back" href="{% url 'store' %}">&#x2190; Back to store</a>
              
            
    
            <br>
            <br>
            
                <div class="row">
               
                    <div class="cart-row book_data">
                      <div style="flex:2"><img class="row-image" src="{{ cart_items.book.coverImg }}" class="card-img-top" alt="{{ item.book.title }}"></div>
                      <div style="flex:1; margin-right: 50px;"><p>{{ cart_items.book.title }}</p></div>
                      <div style="flex:1"><p>Rs.{{ cart_items.book.price }}</p></div>
                      <div style="flex:1"><p>Quantity: {{ cart_items.quantity }}</p></div>
                  </div>
                
                </div>
                <div class="order-total text-center">
                    <p style="color: red;">Total: Rs. {{ total }}</p>
                </div>
                <div class="checkout-button text-center">
                  
                        <button class="btn btn-primary" id="payment-button">Pay with Khalti</button>
                 
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .row {
        margin-top: 30px;
    }
    .box-element{
      box-shadow: hsl(0, 0%, 80%) 0 0 16px;
      background-color: #fff;
      border-radius: 10px;
      padding: 10px;
      max-width: 800px; /* decrease this value to reduce the width */
      margin: 0 auto; /* add this to center the element */
  }
 
    .row-image {
        width: 100px;
        height: 50px;
    }
    .btn:hover {
        background-color: white;
        color: black;
    }
    .cart-row {
        display: flex;
        align-items: flex-stretch;
        padding-bottom: 10px;
        margin-bottom: 10px;
        border-bottom: 1px solid #ececec;
    }
    .order-total {
        margin-top: 20px;
    }


    .order-total, .checkout-button {
      text-align: center;
  }
  
  .checkout-button button {
      margin-top: 20px;
      
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
  }
  
  .checkout-button button:hover {
      background-color: darkred;
  }
 
 
</style>

<script src="https://khalti.s3.ap-south-1.amazonaws.com/KPG/dist/2020.12.17.0.0.0/khalti-checkout.iffe.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
<script>

      var config = {
              // replace the publicKey with yours
              "publicKey": "test_public_key_314531128d0247a8a70d4b1da91a4634",
              "productIdentity": "1234567890",
              "productName": "Dragon",
              "productUrl": "http://gameofthrones.wikia.com/wiki/Dragons",
              "paymentPreference": [
                  "KHALTI",
                  
                  ],
              "eventHandler": {
                  onSuccess (payload) {
                      
                      console.log(payload);
                      axios.get("/verify-payment/", {
                          params : {
                              "token" : payload.token,
                              "amount" : payload.amount,
                              "cartid" : "{{cart.id}}"

                          }
                      }).then(function(res){
                          if (res.data.success){
                            // create a popup element
                            var popupParent = document.createElement("div");
                            popupParent.classList.add("popup__parent");

                            var popup = document.createElement("div");
                            popup.classList.add("popup");

                            // create a checked sign element
                            var checkSign = document.createElement("img");
                            checkSign.src = "https://cdn-icons-png.flaticon.com/512/5709/5709755.png";
                            checkSign.classList.add("popup__check-sign");
                            popup.appendChild(checkSign);

                            // create a text element
                            var text = document.createElement("p");
                            text.textContent = "Payment Success";
                            text.classList.add("popup__text");
                            popup.appendChild(text);

                            // create a button element
                            var button = document.createElement("button");
                            button.textContent = "Continue";
                            button.classList.add("popup__button");
                            button.addEventListener("click", function () {
                                location.href = "{% url 'my_books'%}";
                            });
                            popup.appendChild(button);

                            popupParent.appendChild(popup);

                            // append the popup parent element to the body
                            document.body.appendChild(popupParent);

                          }else{
                            alert("Sorry an error occured")
                            location.href = "{{ request.build_absolute_uri }"
                          }
                      })
                      
                  },
                  onError (error) {
                      console.log(error);
                  },
                  onClose () {
                      console.log('widget is closing');
                  }
              }
          };
  
          var checkout = new KhaltiCheckout(config);
          var amount = {{total}}*100;
          var btn = document.getElementById("payment-button");
          btn.onclick = function () {
              
              checkout.show({amount:amount});
          }
  </script>

 
    <style>
        .popup__parent {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
          }
          
          .popup {
            background-color: #fff;
            border-radius: 8px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
          }
          
          .popup__check-sign {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
          }
          
          .popup__text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 16px;
          }
          
          .popup__button {
            background-color: #007aff;
            color: #fff;
            font-size: 18px;
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
          }
          
          .popup__button:hover {
            background-color: #0062cc;
          }
          .desc{
            height:190px;
          }
    </style>
    <div class="desc"></div>
    {%include "footer.html"%}
   